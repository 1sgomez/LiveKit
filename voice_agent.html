<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Voice Client</title>
    <script src="https://unpkg.com/livekit-client/dist/livekit-client.umd.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
        max-width: 800px;
        margin: 0 auto;
      }
      textarea {
        width: 100%;
        padding: 10px;
        font-family: monospace;
      }
      button {
        padding: 10px 20px;
        margin: 10px 5px;
        cursor: pointer;
      }
      #messageDisplay {
        margin-top: 20px;
        padding: 15px;
        border: 2px solid #4caf50;
        border-radius: 5px;
        background-color: #f0f9ff;
        font-size: 18px;
        display: none;
      }
      #status {
        padding: 10px;
        background: #e8f5e9;
        border-radius: 5px;
        margin-bottom: 20px;
      }
    </style>
  </head>
  <body>
    <h1>üéôÔ∏è Voice Client con Comandos</h1>

    <div id="status">üî¥ Desconectado</div>

    <h3>Enviar datos de herramientas:</h3>
    <textarea
      id="toolData"
      placeholder='{"tool_name": "driver.js", "data": {...}}'
      rows="10"
    ></textarea>
    <br />
    <button onclick="enviarDatos()">Enviar Datos</button>

    <!-- üÜï √Årea para mostrar mensajes del agente -->
    <div id="messageDisplay"></div>

    <script>
      let sala = null;
      let userIdentity = null;
      let roomName = "test";

      // üÜï Funciones que el agente puede ejecutar
      function mostrarMensaje(mens) {
        console.log("üñ•Ô∏è EJECUTANDO mostrarMensaje():", mens);

        const display = document.getElementById("messageDisplay");
        display.textContent = "ü§ñ " + mens;
        display.style.display = "block";

        // Auto-ocultar despu√©s de 10 segundos
        setTimeout(() => {
          display.style.display = "none";
        }, 10000);
      }

      function ejecutarAlerta(mens) {
        console.log("‚ö†Ô∏è EJECUTANDO ejecutarAlerta():", mens);
        alert("ü§ñ Jarvis dice: " + mens);
      }

      function mostrarNotificacion(mens) {
        console.log("üîî EJECUTANDO mostrarNotificacion():", mens);
        if (Notification.permission === "granted") {
          new Notification("Jarvis", { body: mens });
        }
      }

      // üÜï Procesador de comandos del agente
      function procesarComandoAgente(command, data) {
        console.log(`üéØ PROCESANDO COMANDO: ${command}`);
        console.log("üì¶ Datos:", data);

        switch (command) {
          case "mostrar_mensaje":
            mostrarMensaje(data);
            break;

          case "alerta":
            ejecutarAlerta(data);
            break;

          case "notificacion":
            mostrarNotificacion(data);
            break;

          default:
            console.warn(`‚ö†Ô∏è Comando desconocido: ${command}`);
        }
      }

      // Funci√≥n global para enviar datos desde cualquier lugar
      window.sendToolData = async function (toolName, data) {
        if (!sala || !sala.localParticipant) {
          console.error("‚ùå No conectado a la sala");
          return false;
        }

        try {
          const payload = {
            type: "tool_data",
            tool_name: toolName,
            data: data,
            user_identity: userIdentity,
          };

          const encoder = new TextEncoder();
          const dataBytes = encoder.encode(JSON.stringify(payload));

          await sala.localParticipant.publishData(dataBytes, {
            reliable: true,
            destinationIdentities: [],
          });

          console.log(
            `‚úÖ Datos de ${toolName} enviados directamente a LiveKit`
          );

          // Opcional: Tambi√©n enviar a Flask para logging
          await fetch("http://localhost:5000/tool-data", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              room: roomName,
              user_identity: userIdentity,
              tool_name: toolName,
              data: data,
            }),
          });

          return true;
        } catch (err) {
          console.error("‚ùå Error enviando datos:", err);
          return false;
        }
      };

      // Escuchar mensajes desde otros contextos
      window.addEventListener("message", function (event) {
        if (event.data.type === "send_tool_data") {
          window.sendToolData(event.data.tool_name, event.data.data);
        }
      });

      // Enviar datos desde el textarea
      function enviarDatos() {
        try {
          const input = JSON.parse(document.getElementById("toolData").value);
          window.sendToolData(input.tool_name, input.data);
        } catch (err) {
          alert("JSON inv√°lido: " + err.message);
        }
      }

      async function conectarAutomaticamente() {
        try {
          if (!window.LivekitClient) {
            console.error("LiveKit no cargado");
            return;
          }

          const nombre = "usuario-" + Math.random().toString(36).substring(7);
          userIdentity = nombre;

          const tokenUrl = `http://localhost:5000/token?room=${roomName}&name=${nombre}`;
          const res = await fetch(tokenUrl);
          const datos = await res.json();

          const { Room } = window.LivekitClient;
          sala = new Room();

          sala.on("trackSubscribed", (track, publication, participant) => {
            if (track.kind === "audio") {
              const audioElement = track.attach();
              audioElement.play().catch(() => {});
            }
          });

          // üÜï ESCUCHAR comandos del agente
          sala.on("dataReceived", (payload, participant) => {
            console.log("üì® dataReceived evento disparado");
            console.log("   Participante:", participant?.identity);
            console.log("   Payload size:", payload.byteLength, "bytes");

            try {
              const decoder = new TextDecoder();
              const text = decoder.decode(payload);
              console.log("   Texto decodificado:", text);

              const data = JSON.parse(text);
              console.log("   JSON parseado:", data);

              // üî• Si es un comando del agente, ejecutarlo
              if (data.type === "agent_command") {
                console.log("‚úÖ Es un comando del agente!");
                procesarComandoAgente(data.command, data.data);
              } else {
                console.log("‚ÑπÔ∏è No es un comando del agente, type:", data.type);
              }
            } catch (err) {
              console.error("‚ùå Error procesando data:", err);
            }
          });

          await sala.connect(datos.url, datos.token, {
            autoSubscribe: true,
            dynacast: false,
          });

          await sala.localParticipant.setMicrophoneEnabled(true);

          document.getElementById("status").textContent =
            "‚úÖ Conectado: " + nombre;
          document.getElementById("status").style.background = "#e8f5e9";

          console.log("‚úÖ Conectado:", nombre);
          console.log("üìç Sala:", roomName);
          console.log("üéß Listeners registrados");

          // Pedir permiso para notificaciones
          if (Notification.permission === "default") {
            Notification.requestPermission();
          }
        } catch (err) {
          console.error("Error:", err);
          document.getElementById("status").textContent =
            "‚ùå Error de conexi√≥n";
          document.getElementById("status").style.background = "#ffebee";
        }
      }

      window.addEventListener("load", conectarAutomaticamente);
    </script>
  </body>
</html>
