<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Voice Client</title>
    <script src="https://unpkg.com/livekit-client/dist/livekit-client.umd.js"></script>
  </head>
  <body>
    <textarea
      id="toolData"
      placeholder='{"tool_name": "driver.js", "data": {...}}'
      rows="10"
      cols="50"
    ></textarea>
    <br />
    <button onclick="enviarDatos()">Enviar</button>

    <script>
      function mostrarMensaje(mens) {
        alert(mens);
      }

      let sala = null;
      let userIdentity = null;
      let roomName = "test";

      // üÜï Funci√≥n DIRECTA a LiveKit (sin pasar por Flask)
      window.sendToolData = async function (toolName, data) {
        if (!sala || !sala.localParticipant) {
          console.error("‚ùå No conectado a la sala");
          return false;
        }

        try {
          const payload = {
            type: "tool_data",
            tool_name: toolName,
            data: data,
            user_identity: userIdentity,
          };

          // üî• ENVIAR DIRECTAMENTE V√çA LIVEKIT
          const encoder = new TextEncoder();
          const dataBytes = encoder.encode(JSON.stringify(payload));

          await sala.localParticipant.publishData(dataBytes, {
            reliable: true,
            destinationIdentities: [], // Broadcast a todos
          });

          console.log(
            `‚úÖ Datos de ${toolName} enviados directamente a LiveKit`
          );
          console.log("üì¶ Payload:", payload);

          // üÜï OPCIONAL: Tambi√©n enviar a Flask para logging/storage
          await fetch("http://localhost:5000/tool-data", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              room: roomName,
              user_identity: userIdentity,
              tool_name: toolName,
              data: data,
            }),
          });

          return true;
        } catch (err) {
          console.error("‚ùå Error enviando datos:", err);
          return false;
        }
      };

      // Escuchar mensajes desde otros contextos (iframes, windows, etc)
      window.addEventListener("message", function (event) {
        if (event.data.type === "send_tool_data") {
          window.sendToolData(event.data.tool_name, event.data.data);
        }
      });

      // Enviar datos desde el textarea
      function enviarDatos() {
        try {
          const input = JSON.parse(document.getElementById("toolData").value);
          window.sendToolData(input.tool_name, input.data);
        } catch (err) {
          alert("JSON inv√°lido: " + err.message);
        }
      }

      async function conectarAutomaticamente() {
        try {
          if (!window.LivekitClient) {
            console.error("LiveKit no cargado");
            return;
          }

          const nombre = "usuario-" + Math.random().toString(36).substring(7);
          userIdentity = nombre;

          const tokenUrl = `http://localhost:5000/token?room=${roomName}&name=${nombre}`;
          const res = await fetch(tokenUrl);
          const datos = await res.json();

          const { Room } = window.LivekitClient;
          sala = new Room();

          sala.on("trackSubscribed", (track, publication, participant) => {
            if (track.kind === "audio") {
              const audioElement = track.attach();
              audioElement.play().catch(() => {});
            }
          });

          // üÜï ESCUCHAR data messages (opcional, para debugging)
          sala.on("dataReceived", (payload, participant) => {
            try {
              const decoder = new TextDecoder();
              const text = decoder.decode(payload);
              const data = JSON.parse(text);
              console.log("üì® Data recibida:", data);
            } catch (err) {
              console.log("üì® Data recibida (no JSON):", payload);
            }
          });

          await sala.connect(datos.url, datos.token, {
            autoSubscribe: true,
            dynacast: false,
          });

          await sala.localParticipant.setMicrophoneEnabled(true);
          console.log("‚úÖ Conectado:", nombre);
          console.log("üìç Sala:", roomName);
        } catch (err) {
          console.error("Error:", err);
        }
      }

      window.addEventListener("load", conectarAutomaticamente);
    </script>
  </body>
</html>
